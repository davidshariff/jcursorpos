/**
 * jCursorPos
 * 
 * Version 2.0
 * 
 * https://github.com/davidshariff/jCursorPos
 *
 * Copyright (c) 2013 David Shariff
 * http://davidshariff.com/blog/
 *
 * Licensed under the MIT license.
 * 
 **/

/**
 * Situations Tested
 * 1. Spaces between words in a sentence
 * 2. Multiple spaces between words
 * 3. Multiple spaces by themselve without words
 * 4. Line breaks without words
 * 5. Line breaks with multiple words
 * 6. Cursor at beginning and end of lines
 **/
(function(e,t,n,r){"use strict";function u(t,n){this.$el=e(t);this.$clone={};this.$cursor={};this.options=e.extend({},i,n);this._defaults=i;this.init()}var i={onChange:function(){},className:"jCursorPos"},s={clone:'<pre class="'+i.className+" "+i.className+'-clone"></pre>',clone_cursor:'<span class="'+i.className+" "+i.className+'-cursor"></span>',linebreak:"&#8203;<br>&#8203;",space:"&#8203;&nbsp;&#8203;"},o={linebreak:/\r\n|\r|\n/g,trim_space:/^ +| +$/gm,trim_lead_space:/[^\S\n]+$/g,space_and_lb:/[\n\r\s]+/g,whitespace:/[^\S\n]/g};u.prototype={init:function(){var e=this;this.createPluginStyles();this.createClone();this.$el.bind("keyup keydown paste focus mouseup",function(){e.updateCursor();e.updateOrig();e.options.onChange.call(e.$el,e.$cursor)})},calcCursor:function(){var e,t;if(this.$el.width()!==this.$clone.width()||this.$el.height()!==this.$clone.height()){this.cloneStyles()}e=this.$el.offset();t=this.$clone.find("."+i.className+"-cursor").position();return{position:t,offset:{left:e.left+t.left-this.$el.scrollLeft(),top:e.top+t.top-this.$el.scrollTop()}}},cloneStyles:function(){var e=["font-family","font-size","font-weight","font-style","color","text-transform","text-decoration","letter-spacing","word-spacing","line-height","text-align","vertical-align","direction","background-color","background-image","background-repeat","background-position","background-attachment","opacity","width","height","top","right","bottom","left","margin-top","margin-right","margin-bottom","margin-left","padding-top","padding-right","padding-bottom","padding-left","border-top-width","border-right-width","border-bottom-width","border-left-width","border-top-color","border-right-color","border-bottom-color","border-left-color","border-top-style","border-right-style","border-bottom-style","border-left-style","position","display","visibility","z-index","overflow-x","overflow-y","white-space","clip","float","clear","cursor","list-style-image","list-style-position","list-style-type","marker-offset"],t=this.$el.prop("tagName")==="TEXTAREA"?"break-word":"normal",n=this.$el.prop("tagName")==="TEXTAREA"?"pre-wrap":"nowrap";this.$clone.css(this.$el.css(e)).css({left:"-9999px",position:"absolute","word-wrap":t,"white-space":n});if(this.$el.get(0).scrollHeight>this.$el.innerHeight()){this.$clone.css("overflow-y","scroll")}if(this.$el.get(0).scrollWidth>this.$el.innerWidth()){this.$clone.css("overflow-x","scroll")}},createClone:function(){this.$clone=e(s.clone).appendTo(e("body"));this.cloneStyles()},createPluginStyles:function(){var t=e("."+i.className+"-styles"),n="."+i.className+"-cursor { display: inline-block; padding: 0; border: 0; }";if(t.length===0){e('<style class="'+i.className+'-styles">'+n+"</style>").appendTo("head")}},getCaretPos:function(){var e=this.$el[0],t=0;if("selectionStart"in e){t=e.selectionStart}else if("selection"in n){e.focus();var r=e.createTextRange(),i=n.selection.createRange().duplicate(),s=i.getBookmark();r.moveToBookmark(s);while(r.moveStart("character",-1)!==0){t++}}return t},getText:function(){return this.$el[0].contentEditable==="true"?this.$el.html():this.$el.val()},textToHTML:function(t){if(!e.support.leadingWhitespace){t.replace(/ /g,s.space)}return t.replace(o.linebreak,s.linebreak)},wrapCharAtPos:function(e,t,n){return e.slice(0,t)+'<span class="'+n+'">'+e.slice(t,t+1)+"</span>"+e.slice(t+1,e.length)},wrapWordAtPos:function(e,t,n){var r={first:{classname:"after-word"},last:{classname:"before-word"}};var i=[],u=[],a="",f="",l="";if(t==="last"){var c=e.match(o.trim_lead_space),h=c?c[0].length:0;if(h>0){e=e.replace(o.trim_lead_space,"");for(var p=0;p<h;p++){l+=" "||s.space}}e=e.replace(o.whitespace,"!");i=e.split("!");f+=i.pop();a+=i.join(" ");u=f.split(o.linebreak)||[];if(u.length>1){f=u.pop();a+=u.join(s.linebreak)+s.linebreak}if(i.length>0){a+=s.space}}else{if(n===" "){e=e.substring(1);a+=" "}i=e.split(o.space_and_lb);f+=i.shift();l+=" "+i.join(" ")}e=[a,'<span class="'+r[t].classname+'">',f,"</span>",l].join("");return e},updateCursor:function(){var t=this.getCaretPos(),n=this.getText(),r=n.substring(0,t),i=n.substring(t),u=n.charAt(t-1),a=n.charAt(t),f,l;r=this.wrapWordAtPos(r,"last",u);i=this.wrapWordAtPos(i,"first",a);this.$clone.html(this.textToHTML(r)+s.clone_cursor+this.textToHTML(i));f=e(".before-word");l=e(".after-word");if(l.html().length>0&&t>0&&l.position().top>f.position().top){if(u===" "){f.after(s.linebreak)}else if(a!==" "&&!u.match(o.linebreak)){f.before(s.linebreak)}}this.$cursor=this.calcCursor()},updateOrig:function(){this.$el.attr({"data-jcursorpos-offset-left":this.$cursor.offset.left,"data-jcursorpos-offset-top":this.$cursor.offset.top,"data-jcursorpos-position-left":this.$cursor.position.left,"data-jcursorpos-position-top":this.$cursor.position.top})}};e.fn.jCursorPos=function(t){return this.each(function(){if(!e.data(this,"plugin_jCursorPos")){e.data(this,"plugin_jCursorPos",new u(this,t))}})}})(jQuery,window,document)
